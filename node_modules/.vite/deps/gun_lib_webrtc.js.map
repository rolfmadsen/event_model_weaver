{
  "version": 3,
  "sources": ["../../gun/lib/webrtc.js"],
  "sourcesContent": [";(function(){\n\tvar Gun = (typeof window !== \"undefined\")? window.Gun : require('../gun');\n\tGun.on('opt', function(root){\n\t\tthis.to.next(root);\n\t\tvar opt = root.opt;\n\t\tif(root.once){ return }\n\t\tif(!Gun.Mesh){ return }\n\t\tif(false === opt.RTCPeerConnection){ return }\n\n\t\tvar env;\n\t\tif(typeof window !== \"undefined\"){ env = window }\n\t\tif(typeof global !== \"undefined\"){ env = global }\n\t\tenv = env || {};\n\n\t\tvar rtcpc = opt.RTCPeerConnection || env.RTCPeerConnection || env.webkitRTCPeerConnection || env.mozRTCPeerConnection;\n\t\tvar rtcsd = opt.RTCSessionDescription || env.RTCSessionDescription || env.webkitRTCSessionDescription || env.mozRTCSessionDescription;\n\t\tvar rtcic = opt.RTCIceCandidate || env.RTCIceCandidate || env.webkitRTCIceCandidate || env.mozRTCIceCandidate;\n\t\tif(!rtcpc || !rtcsd || !rtcic){ return }\n\t\topt.RTCPeerConnection = rtcpc;\n\t\topt.RTCSessionDescription = rtcsd;\n\t\topt.RTCIceCandidate = rtcic;\n\t\topt.rtc = opt.rtc || {'iceServers': [\n      {urls: 'stun:stun.l.google.com:19302'},\n      {urls: \"stun:stun.sipgate.net:3478\"}/*,\n      {urls: \"stun:stun.stunprotocol.org\"},\n      {urls: \"stun:stun.sipgate.net:10000\"},\n      {urls: \"stun:217.10.68.152:10000\"},\n      {urls: 'stun:stun.services.mozilla.com'}*/ \n    ]};\n    // TODO: Select the most appropriate stuns. \n    // FIXME: Find the wire throwing ICE Failed\n    // The above change corrects at least firefox RTC Peer handler where it **throws** on over 6 ice servers, and updates url: to urls: removing deprecation warning \n    opt.rtc.dataChannel = opt.rtc.dataChannel || {ordered: false, maxRetransmits: 2};\n    opt.rtc.sdp = opt.rtc.sdp || {mandatory: {OfferToReceiveAudio: false, OfferToReceiveVideo: false}};\n    opt.rtc.max = opt.rtc.max || 55; // is this a magic number? // For Future WebRTC notes: Chrome 500 max limit, however 256 likely - FF \"none\", webtorrent does 55 per torrent.\n    opt.rtc.room = opt.rtc.room || Gun.window && (location.hash.slice(1) || location.pathname.slice(1));\n    opt.announce = function(to){\n\t\t\topt.rtc.start = +new Date; // handle room logic:\n\t\t\troot.$.get('/RTC/'+opt.rtc.room+'<?99').get('+').put(opt.pid, function(ack){\n\t\t\t\tif(!ack.ok || !ack.ok.rtc){ return }\n\t\t\t\topen(ack);\n\t\t\t}, {acks: opt.rtc.max}).on(function(last,key, msg){\n\t\t\t\tif(last === opt.pid || opt.rtc.start > msg.put['>']){ return }\n\t\t\t\topen({'#': ''+msg['#'], ok: {rtc: {id: last}}});\n\t\t\t});\n    };\n\n\t\tvar mesh = opt.mesh = opt.mesh || Gun.Mesh(root);\n\t\troot.on('create', function(at){\n\t\t\tthis.to.next(at);\n\t\t\tsetTimeout(opt.announce, 1);\n\t\t});\n\n\t\tfunction open(msg){\n\t\t\tif(this && this.off){ this.off() } // Ignore this, because of ask / ack.\n\t\t\tif(!msg.ok){ return }\n\t\t\tvar rtc = msg.ok.rtc, peer, tmp;\n\t\t\tif(!rtc || !rtc.id || rtc.id === opt.pid){ return }\n\t\t\t//console.log(\"webrtc:\", JSON.stringify(msg));\n\t\t\tif(tmp = rtc.answer){\n\t\t\t\tif(!(peer = opt.peers[rtc.id] || open[rtc.id]) || peer.remoteSet){ return }\n\t\t\t\ttmp.sdp = tmp.sdp.replace(/\\\\r\\\\n/g, '\\r\\n');\n\t\t\t\treturn peer.setRemoteDescription(peer.remoteSet = new opt.RTCSessionDescription(tmp)); \n\t\t\t}\n\t\t\tif(tmp = rtc.candidate){\n\t\t\t\tpeer = opt.peers[rtc.id] || open[rtc.id] || open({ok: {rtc: {id: rtc.id}}});\n\t\t\t\treturn peer.addIceCandidate(new opt.RTCIceCandidate(tmp));\n\t\t\t}\n\t\t\t//if(opt.peers[rtc.id]){ return }\n\t\t\tif(open[rtc.id]){ return }\n\t\t\t(peer = new opt.RTCPeerConnection(opt.rtc)).id = rtc.id;\n\t\t\tvar wire = peer.wire = peer.createDataChannel('dc', opt.rtc.dataChannel);\n\t\t\topen[rtc.id] = peer;\n\t\t\twire.to = setTimeout(function(){delete open[rtc.id]},1000*60);\n\t\t\twire.onclose = function(){ mesh.bye(peer) };\n\t\t\twire.onerror = function(err){ };\n\t\t\twire.onopen = function(e){\n\t\t\t\tdelete open[rtc.id];\n\t\t\t\tmesh.hi(peer);\n\t\t\t}\n\t\t\twire.onmessage = function(msg){\n\t\t\t\tif(!msg){ return }\n\t\t\t\t//console.log('via rtc');\n\t\t\t\tmesh.hear(msg.data || msg, peer);\n\t\t\t};\n\t\t\tpeer.onicecandidate = function(e){ // source: EasyRTC!\n        if(!e.candidate){ return }\n        root.on('out', {'@': msg['#'], ok: {rtc: {candidate: e.candidate, id: opt.pid}}});\n\t\t\t}\n\t\t\tpeer.ondatachannel = function(e){\n\t\t\t\tvar rc = e.channel;\n\t\t\t\trc.onmessage = wire.onmessage;\n\t\t\t\trc.onopen = wire.onopen;\n\t\t\t\trc.onclose = wire.onclose;\n\t\t\t}\n\t\t\tif(tmp = rtc.offer){\n\t\t\t\trtc.offer.sdp = rtc.offer.sdp.replace(/\\\\r\\\\n/g, '\\r\\n')\n\t\t\t\tpeer.setRemoteDescription(new opt.RTCSessionDescription(tmp)); \n\t\t\t\tpeer.createAnswer(function(answer){\n\t\t\t\t\tpeer.setLocalDescription(answer);\n\t\t\t\t\troot.on('out', {'@': msg['#'], ok: {rtc: {answer: answer, id: opt.pid}}});\n\t\t\t\t}, function(){}, opt.rtc.sdp);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tpeer.createOffer(function(offer){\n\t\t\t\tpeer.setLocalDescription(offer);\n\t\t\t\troot.on('out', {'@': msg['#'], '#': root.ask(open), ok: {rtc: {offer: offer, id: opt.pid}}});\n\t\t\t}, function(){}, opt.rtc.sdp);\n\t\t\treturn peer;\n\t\t}\n\t});\n}());"],
  "mappings": "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",
  "names": ["msg"]
}
